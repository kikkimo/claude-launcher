#!/usr/bin/env node

/**
 * Claude Launcher - Refactored modular version
 * A launcher for Claude Code with third-party API support
 */

const ApiManager = require('./lib/api-manager');
const Menu = require('./lib/ui/menu');
const colors = require('./lib/ui/colors');
const {
    waitForKey,
    promptForThirdPartyApi,
    confirmAction,
    showSuccess,
    showError,
    showInfo
} = require('./lib/ui/prompts');
const {
    launchClaudeDefault,
    launchClaudeSkipPermissions,
    launchClaudeWithApi
} = require('./lib/launcher');
const { getPasswordInput } = require('./lib/auth/password-input');
const { verifyExportPassword, setupNewPassword, changePassword: changePasswordModule } = require('./lib/auth/password-validator');
const { maskApiToken } = require('./lib/validators');
const { showApiSelectionTable, confirmDeletion } = require('./lib/ui/interactive-table');
const fs = require('fs');
const path = require('path');
const os = require('os');
const { exec } = require('child_process');

// Initialize components
const apiManager = new ApiManager();

// Global menu objects to prevent screen flickering during navigation
let globalMainMenu = null;
let globalConfirmMenu = null;
let globalApiManagementMenu = null;

/**
 * Initialize global menu objects to prevent recreation and screen flickering
 */
function initializeGlobalMenus() {
    if (!globalMainMenu) {
        globalMainMenu = new Menu();
    }
    if (!globalConfirmMenu) {
        globalConfirmMenu = new Menu();
    }
    if (!globalApiManagementMenu) {
        globalApiManagementMenu = new Menu();
    }
}

/**
 * Get export directory path and create if not exists
 * @returns {string} - Export directory path
 */
function getExportDirectory() {
    const userHome = os.homedir();
    const exportDir = path.join(userHome, 'claude-launcher');

    // Create directory if it doesn't exist
    if (!fs.existsSync(exportDir)) {
        fs.mkdirSync(exportDir, { recursive: true });
    }

    return exportDir;
}

/**
 * Generate timestamp-based filename for export
 * @returns {string} - Filename with timestamp
 */
function generateExportFilename() {
    const now = new Date();
    const timestamp = now.getFullYear().toString() +
                     (now.getMonth() + 1).toString().padStart(2, '0') +
                     now.getDate().toString().padStart(2, '0') +
                     now.getHours().toString().padStart(2, '0') +
                     now.getMinutes().toString().padStart(2, '0') +
                     now.getSeconds().toString().padStart(2, '0');

    return `claude-launcher-export-${timestamp}.json`;
}

/**
 * Open file with system default application
 * @param {string} filePath - Path to the file to open
 */
function openFileWithDefault(filePath) {
    const platform = process.platform;
    let command;

    if (platform === 'win32') {
        command = `start "" "${filePath}"`;
    } else if (platform === 'darwin') {
        command = `open "${filePath}"`;
    } else {
        command = `xdg-open "${filePath}"`;
    }

    exec(command, (error) => {
        if (error) {
            console.log(colors.yellow + `Could not open file automatically: ${error.message}` + colors.reset);
        }
    });
}

/**
 * Validate import file path and JSON format
 * @param {string} filePath - Path to the JSON file
 * @returns {Object} - Validation result with success status and data/error
 */
function validateImportFile(filePath) {
    const result = {
        valid: false,
        data: null,
        error: null
    };

    try {
        // Check if file path is provided
        if (!filePath || filePath.trim() === '') {
            result.error = 'File path cannot be empty';
            return result;
        }

        // Normalize and resolve path
        const normalizedPath = path.resolve(filePath.trim());

        // Check if file exists
        if (!fs.existsSync(normalizedPath)) {
            result.error = `File does not exist: ${normalizedPath}`;
            return result;
        }

        // Check if it's a file (not directory)
        const stats = fs.statSync(normalizedPath);
        if (!stats.isFile()) {
            result.error = `Path is not a file: ${normalizedPath}`;
            return result;
        }

        // Check file extension
        if (path.extname(normalizedPath).toLowerCase() !== '.json') {
            result.error = `File must have .json extension: ${normalizedPath}`;
            return result;
        }

        // Read and parse JSON file
        const fileContent = fs.readFileSync(normalizedPath, 'utf8');

        // Validate JSON format
        let jsonData;
        try {
            jsonData = JSON.parse(fileContent);
        } catch (parseError) {
            result.error = `Invalid JSON format: ${parseError.message}`;
            return result;
        }

        // Basic structure validation for claude-launcher config
        if (!jsonData || typeof jsonData !== 'object') {
            result.error = 'JSON file must contain a valid configuration object';
            return result;
        }

        // Check for required fields (basic validation)
        if (!jsonData.hasOwnProperty('apis') || !Array.isArray(jsonData.apis)) {
            result.error = 'JSON file must contain an "apis" array';
            return result;
        }

        result.valid = true;
        result.data = fileContent; // Return raw JSON string for compatibility
        return result;

    } catch (error) {
        result.error = `File validation error: ${error.message}`;
        return result;
    }
}

// Main menu options - simplified to 6 items
const menuOptions = [
    'Launch Claude Code',
    'Launch Claude Code (Skip Permissions)',
    'Launch Claude Code with 3rd-party API',
    'Launch Claude Code with 3rd-party API (Skip Permissions)',
    '3rd-party API Management',
    'Exit'
];

/**
 * Add new third-party API
 */
async function addNewThirdPartyApi() {
    try {
        const apiData = await promptForThirdPartyApi();

        // Check if this is the first API
        const isFirstApi = apiManager.getApis().length === 0;
        const hasExportPassword = apiManager.hasExportPassword();

        const newApi = apiManager.addApi(
            apiData.baseUrl,
            apiData.authToken,
            apiData.model,
            apiData.name,
            apiData.provider
        );

        showSuccess('Third-party API added successfully!', [
            `Name: ${newApi.name}`,
            `Provider: ${newApi.provider}`,
            `Base URL: ${newApi.baseUrl}`,
            `Model: ${newApi.model}`
        ]);

        if (isFirstApi) {
            showInfo('This is your first API - it has been set as active');
        }

    } catch (error) {
        showError('Failed to add API', [error.message]);
    }

    await waitForKey('Press any key to continue...');
}

/**
 * Remove third-party API
 */
async function removeThirdPartyApi() {
    try {
        while (true) {
            // Get fresh API list each iteration
            const apis = apiManager.getApis();

            if (apis.length === 0) {
                showInfo('No third-party APIs configured', [
                    'All APIs have been removed or none were configured.'
                ]);
                await waitForKey('Press any key to return to main menu...');
                return showMenu();
            }

            const activeApi = apiManager.getActiveApi();
            const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

            // Show API selection table
            const selectedApi = await showApiSelectionTable(
                apis,
                '[!] Select API to remove:',
                'remove',
                activeIndex
            );

            if (!selectedApi) {
                return showMenu();
            }

            // Show confirmation dialog
            const confirmed = await confirmDeletion(selectedApi);

            if (confirmed) {
                try {
                    // Find the index of the selected API in the current list
                    const selectedIndex = apis.findIndex(api => api.id === selectedApi.id);
                    apiManager.removeApi(selectedIndex);

                    console.clear();
                    showSuccess('API removed successfully!', [
                        `Removed: ${selectedApi.name}`,
                        `Provider: ${selectedApi.provider}`
                    ]);

                    // Check if there are more APIs to remove
                    const remainingApis = apiManager.getApis();
                    if (remainingApis.length === 0) {
                        showInfo('All APIs have been removed');
                        await waitForKey('Press any key to continue...');
                        return showMenu();
                    } else {
                        await waitForKey('Press any key to continue selecting APIs to remove...');
                        // Continue the loop to show updated list
                    }

                } catch (removeError) {
                    showError('Failed to remove API', [removeError.message]);
                    await waitForKey('Press any key to continue...');
                    return showMenu();
                }
            } else {
                showInfo('Removal cancelled');
                await waitForKey('Press any key to continue...');
                // Continue the loop to show the list again
            }
        }

    } catch (error) {
        showError('Failed to remove API', [error.message]);
        await waitForKey('Press any key to continue...');
    }
}

/**
 * Switch active third-party API
 */
async function switchThirdPartyApi() {
    try {
        const apis = apiManager.getApis();
        const activeApi = apiManager.getActiveApi();
        const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

        const selectedApi = await showApiSelectionTable(
            apis,
            '[!] Select API to switch to:',
            'switch',
            activeIndex
        );

        if (!selectedApi) {
            return showMenu();
        }

        // Find the index of the selected API
        const selectedIndex = apis.findIndex(api => api.id === selectedApi.id);
        const switchedApi = apiManager.setActiveApi(selectedIndex);

        console.clear();
        showSuccess('API switched successfully!', [
            `Active API: ${switchedApi.name}`,
            `Provider: ${switchedApi.provider}`,
            `Base URL: ${switchedApi.baseUrl}`,
            `Model: ${switchedApi.model}`
        ]);

    } catch (error) {
        showError('Failed to switch API', [error.message]);
    }

    await waitForKey('Press any key to continue...');
}

/**
 * View API statistics
 */
async function viewStatistics() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'üìä API Statistics' + colors.reset);
    console.log('');

    const stats = apiManager.getStatistics();
    const apis = apiManager.getApis();

    console.log(colors.cyan + '  Summary:' + colors.reset);
    console.log(colors.gray + `    Total APIs: ${stats.totalApis}` + colors.reset);
    console.log(colors.gray + `    Active API: ${stats.activeApiName}` + colors.reset);
    console.log(colors.gray + `    Most Used: ${stats.mostUsedApi}` + colors.reset);
    console.log(colors.gray + `    Total Usage: ${stats.totalUsage}` + colors.reset);
    console.log('');

    if (apis.length > 0) {
        console.log(colors.cyan + '  Configured APIs:' + colors.reset);
        apis.forEach((api, index) => {
            const isActive = apiManager.getActiveApi()?.id === api.id;
            console.log(colors.gray + `    ${index + 1}. ${api.name}${isActive ? ' (ACTIVE)' : ''}` + colors.reset);
            console.log(colors.dim + `       Provider: ${api.provider}` + colors.reset);
            console.log(colors.dim + `       Usage: ${api.usageCount || 0} times` + colors.reset);
            console.log(colors.dim + `       Created: ${api.createdAt}` + colors.reset);
        });
    }

    console.log('');
    await waitForKey('Press any key to continue...');
}


/**
 * Handle first time password setup
 */
async function handleFirstTimePasswordSetup() {
    while (true) {
        // Clear screen and show header
        console.clear();
        console.log('');
        console.log(colors.bright + colors.yellow + 'üîê First Time Import/Export Setup' + colors.reset);
        console.log('');

        // Show information
        console.log(colors.cyan + 'Why password is needed:' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Import/export features require password verification for user identity' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Exported configurations are in plaintext format for cross-machine compatibility' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Local configurations remain encrypted, password ensures only you can access them' + colors.reset);
        console.log('');
        console.log(colors.cyan + 'üîí New Enhanced Security Requirements:' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Password must be at least 6 characters long' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Must contain at least 2 types: uppercase, lowercase, numbers, or special characters' + colors.reset);
        console.log(colors.gray + '‚Ä¢ ASCII characters only, no spaces allowed' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Advanced protection against weak password patterns' + colors.reset);
        console.log('');
        console.log(colors.yellow + 'Options:' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Set Password: Enable import/export functionality with identity verification' + colors.reset);
        console.log(colors.gray + '‚Ä¢ Skip Setup: Permanently disable import/export features (cannot be undone)' + colors.reset);
        console.log('');
        console.log(colors.red + 'WARNING: Skipping setup will permanently disable import/export functionality!' + colors.reset);
        console.log('');

        // Show menu options statically
        console.log(colors.orange + '  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê' + colors.reset);
        console.log(colors.orange + '  ‚îÇ' + colors.white + colors.bright + '           Claude Code Launcher         ' + colors.orange + '‚îÇ' + colors.reset);
        console.log(colors.orange + '  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò' + colors.reset);
        console.log('');
        console.log(colors.gray + '  Use number keys to select:' + colors.reset);
        console.log('');
        console.log(colors.yellow + '  1. ' + colors.reset + 'Set Password (Recommended)');
        console.log(colors.yellow + '  2. ' + colors.reset + 'Skip Setup (Permanently Disable Import/Export)');
        console.log(colors.gray + '  Any other key: ' + colors.reset + 'Back to Main Menu');
        console.log('');

        // Use simple input instead of Menu class to avoid refresh issues
        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const choice = await new Promise((resolve) => {
            rl.question(colors.green + '[>] Enter your choice (1-2, or any other key to return to main menu): ' + colors.reset, (answer) => {
                rl.close();
                resolve(parseInt(answer) - 1);
            });
        });

        switch (choice) {
            case 0: // Set password
                const passwordResult = await promptForPasswordSetup();
                if (passwordResult) {
                    return true; // Password set successfully
                }
                // If password setup failed, continue loop to show menu again
                break;

            case 1: // Skip setup
                const skipResult = await confirmSkipPassword();
                if (skipResult === true) {
                    return true; // Skip confirmed
                } else if (skipResult === 'reconsider') {
                    continue; // Return to main setup menu
                }
                // If skip was canceled, continue loop
                break;

            case 2: // Back to main menu
            default:
                return false; // Exit setup
        }
    }
}

/**
 * Prompt user to set password
 */
async function promptForPasswordSetup() {
    const result = await setupNewPassword(apiManager, true);
    if (result) {
        await waitForKey('Press any key to continue...');
    }
    return result;
}

/**
 * Confirm skip password setup
 */
async function confirmSkipPassword() {
    console.log('');
    console.log(colors.bright + colors.red + '‚ö†Ô∏è  Confirm Skip Password Setup' + colors.reset);
    console.log('');
    console.log(colors.gray + 'After skipping password setup:' + colors.reset);
    console.log(colors.gray + '‚Ä¢ Import/export functionality will be permanently disabled' + colors.reset);
    console.log(colors.gray + '‚Ä¢ Cannot backup or migrate API configurations' + colors.reset);
    console.log(colors.gray + '‚Ä¢ This decision cannot be undone' + colors.reset);
    console.log('');

    // Ensure global menus are initialized
    initializeGlobalMenus();

    globalConfirmMenu.setOptions([
        'I confirm to skip',
        'Reconsider, return to password setup'
    ]);

    const choice = await globalConfirmMenu.navigate();

    if (choice === 0) {
        try {
            apiManager.skipPasswordSetup();
            console.log(colors.yellow + 'Password setup skipped, import/export functionality permanently disabled' + colors.reset);
            await waitForKey('Press any key to continue...');
            return true;
        } catch (error) {
            console.log(colors.red + `Operation failed: ${error.message}` + colors.reset);
            await waitForKey('Press any key to continue...');
            return false;
        }
    }

    return 'reconsider'; // Return to password setup main menu
}

/**
 * Show API Management Menu
 */
async function showApiManagementMenu() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'üìã 3rd-party API Management' + colors.reset);
    console.log('');

    // Check if this is first time usage and prompt for password setup
    if (apiManager.isFirstTimeUsage()) {
        const passwordChoice = await handleFirstTimePasswordSetup();
        if (!passwordChoice) {
            // User chose to skip or canceled, return to main menu
            return showMenu();
        }
    }

    // Build menu options based on password setup status
    const menuOptions = [
        'Add New API',
        'Remove API',
        'Switch Active API',
        'View API Statistics'
    ];

    // Add import/export options only if password is set
    if (apiManager.canUseImportExport()) {
        menuOptions.push('Export Configuration');
        menuOptions.push('Import Configuration');
        menuOptions.push('Change Password');
    }

    menuOptions.push('Back to Main Menu');

    // Ensure global menus are initialized
    initializeGlobalMenus();

    globalApiManagementMenu.setOptions(menuOptions);

    const choice = await globalApiManagementMenu.navigate();

    // Handle menu choices based on current menu options
    if (choice === 0) { // Add New API
        await addNewThirdPartyApi();
    } else if (choice === 1) { // Remove API
        await removeThirdPartyApi();
    } else if (choice === 2) { // Switch Active API
        await switchThirdPartyApi();
    } else if (choice === 3) { // View API Statistics
        await viewStatistics();
    } else if (apiManager.canUseImportExport()) {
        // If import/export is available, handle those options
        if (choice === 4) { // Export Configuration
            await exportConfiguration();
        } else if (choice === 5) { // Import Configuration
            await importConfiguration();
        } else if (choice === 6) { // Change Password
            await changePassword();
        } else if (choice === 7) { // Back to Main Menu
            return showMenu();
        }
    } else {
        // If import/export is not available, only Back to Main Menu
        if (choice === 4) { // Back to Main Menu
            return showMenu();
        }
    }

    // Return to API management menu after completing action
    showApiManagementMenu();
}

/**
 * Handle third-party API launch
 */
async function handleThirdPartyApiLaunch(skipPermissions = false) {
    try {
        const activeApi = apiManager.getActiveApi();

        if (!activeApi) {
            console.clear();
            showInfo('No Active Third-party API', [
                'No third-party API is currently active.',
                'Please add and configure an API first, or switch to an existing one.'
            ]);

            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        // Increment usage count for the active API since we're actually using it
        apiManager.incrementActiveApiUsage();

        launchClaudeWithApi(activeApi, skipPermissions);

    } catch (error) {
        showError('Failed to launch with third-party API', [error.message]);

        setTimeout(() => {
            showMenu();
        }, 2000);
    }
}

/**
 * Execute selected menu item
 */
async function executeSelection(selectedIndex) {
    switch (selectedIndex) {
        case 0: // Launch Claude Code
            launchClaudeDefault();
            break;

        case 1: // Launch Claude Code (Skip Permissions)
            launchClaudeSkipPermissions();
            break;

        case 2: // Launch Claude Code with 3rd-party API
            await handleThirdPartyApiLaunch(false);
            break;

        case 3: // Launch Claude Code with 3rd-party API (Skip Permissions)
            await handleThirdPartyApiLaunch(true);
            break;

        case 4: // 3rd-party API Management
            await showApiManagementMenu();
            break;

        case 5: // Exit
            console.log('');
            console.log(colors.green + 'üëã Goodbye!' + colors.reset);
            process.exit(0);
            break;

        default:
            showMenu();
            break;
    }
}

/**
 * Show main menu
 */
async function showMenu() {
    // Ensure global menus are initialized
    initializeGlobalMenus();

    globalMainMenu.setOptions(menuOptions);
    const selection = await globalMainMenu.navigate();

    if (selection === -1) {
        console.log('');
        console.log(colors.green + 'üëã Goodbye!' + colors.reset);
        process.exit(0);
    } else {
        await executeSelection(selection);
    }
}





/**
 * Export configuration with password encryption
 */
async function exportConfiguration() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'üíæ Export Configuration' + colors.reset);
    console.log('');

    // Add export function description
    console.log(colors.cyan + 'üìÑ Export Function Description:' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Password verification required to confirm your identity' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Export saves a JSON file to your home directory' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ File contains plaintext API configurations for easy migration' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ File will be automatically opened after export' + colors.reset);
    console.log('');

    // Verify password before export
    const verified = await verifyExportPassword(apiManager, 'export');
    if (!verified) {
        console.log('');
        await waitForKey('Press any key to return...');
        return;
    }

    try {
        // Get export data
        const exportData = apiManager.exportConfigAuthenticated();

        // Prepare file path
        const exportDir = getExportDirectory();
        const filename = generateExportFilename();
        const filePath = path.join(exportDir, filename);

        // Write JSON file
        fs.writeFileSync(filePath, exportData, 'utf8');

        console.log(colors.green + '‚úì Configuration exported successfully!' + colors.reset);
        console.log('');
        console.log(colors.cyan + 'üìÅ Export Details:' + colors.reset);
        console.log(colors.gray + `  ‚Ä¢ File saved to: ${filePath}` + colors.reset);
        console.log(colors.gray + `  ‚Ä¢ Export directory: ${exportDir}` + colors.reset);
        console.log(colors.gray + `  ‚Ä¢ Filename: ${filename}` + colors.reset);
        console.log('');

        // Open file with default application
        console.log(colors.yellow + 'üîç Opening exported file with default application...' + colors.reset);
        openFileWithDefault(filePath);

        console.log('');
        console.log(colors.cyan + 'üí° Tips:' + colors.reset);
        console.log(colors.gray + '  ‚Ä¢ Share this file to migrate configurations to other machines' + colors.reset);
        console.log(colors.gray + '  ‚Ä¢ Keep the file secure as it contains your API configurations' + colors.reset);

    } catch (error) {
        console.log(colors.red + `‚ùå Export failed: ${error.message}` + colors.reset);
    }

    console.log('');
    await waitForKey('Press any key to return...');
}

/**
 * Import configuration from plaintext JSON
 */
async function importConfiguration() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'üì• Import Configuration' + colors.reset);
    console.log('');

    // Add import function description
    console.log(colors.cyan + 'üìÑ Import Function Description:' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Password verification required to confirm your identity' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Import reads a JSON file from the specified file path' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Import data will be merged with current configuration (no overwrite)' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Duplicate API configurations will be automatically skipped' + colors.reset);
    console.log('');

    // Verify password identity
    const passwordVerified = await verifyExportPassword(apiManager, 'import');
    if (!passwordVerified) {
        await waitForKey('Press any key to return...');
        return;
    }

    console.log('');
    console.log(colors.cyan + 'üìÅ File Input Required:' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ Provide the full path to your JSON configuration file' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ File must be a valid JSON file with .json extension' + colors.reset);
    console.log(colors.gray + '  ‚Ä¢ File will be validated before import' + colors.reset);
    console.log('');

    const { simpleInput } = require('./lib/ui/prompts');

    let attempts = 0;
    const maxAttempts = 3;

    while (attempts < maxAttempts) {
        attempts++;

        // Get file path from user
        const filePath = await simpleInput(colors.green + `[>] Enter JSON file path (attempt ${attempts}/${maxAttempts}): ` + colors.reset);

        if (!filePath) {
            console.log(colors.red + 'File path cannot be empty' + colors.reset);
            if (attempts < maxAttempts) {
                console.log('');
                continue;
            } else {
                console.log(colors.red + 'Maximum attempts reached. Import cancelled.' + colors.reset);
                await waitForKey('Press any key to return...');
                return;
            }
        }

        // Validate file
        console.log('');
        console.log(colors.yellow + 'üîç Validating file...' + colors.reset);
        const validation = validateImportFile(filePath);

        if (!validation.valid) {
            console.log(colors.red + `‚ùå File validation failed: ${validation.error}` + colors.reset);
            if (attempts < maxAttempts) {
                console.log(colors.yellow + 'üí° Please check the file path and ensure it\'s a valid JSON file' + colors.reset);
                console.log('');
                continue;
            } else {
                console.log(colors.red + 'Maximum attempts reached. Import cancelled.' + colors.reset);
                await waitForKey('Press any key to return...');
                return;
            }
        }

        // File is valid, proceed with import
        console.log(colors.green + '‚úì File validation successful' + colors.reset);
        console.log('');

        try {
            // Import the validated configuration data
            const result = apiManager.importConfigAuthenticated(validation.data);

            console.log(colors.green + '‚úì Configuration imported successfully!' + colors.reset);
            console.log('');
            console.log(colors.cyan + 'üìä Import Statistics:' + colors.reset);
            console.log(colors.gray + `  ‚Ä¢ Successfully imported: ${result.imported} API configurations` + colors.reset);
            console.log(colors.gray + `  ‚Ä¢ Skipped duplicates: ${result.skipped} API configurations` + colors.reset);
            console.log(colors.gray + `  ‚Ä¢ Configuration merged with existing data` + colors.reset);
            console.log(colors.gray + `  ‚Ä¢ Source file: ${path.resolve(filePath)}` + colors.reset);

            break; // Success, exit the loop

        } catch (error) {
            console.log(colors.red + `‚ùå Import failed: ${error.message}` + colors.reset);
            if (attempts < maxAttempts) {
                console.log(colors.yellow + 'üí° Please check the file content and format' + colors.reset);
                console.log('');
                continue;
            } else {
                console.log(colors.red + 'Maximum attempts reached. Import failed.' + colors.reset);
            }
        }
    }

    console.log('');
    await waitForKey('Press any key to return...');
}

/**
 * Change password
 */
async function changePassword() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'üîë Change Password' + colors.reset);
    console.log('');

    // Use unified password change module
    const success = await changePasswordModule(apiManager);

    if (success) {
        console.log('');
    }

    await waitForKey('Press any key to return...');
}

// End of API Management functions

/**
 * Graceful shutdown handlers
 */
process.on('SIGINT', () => {
    console.log('');
    console.log(colors.green + 'üëã Goodbye!' + colors.reset);
    process.exit(0);
});

process.on('SIGTERM', () => {
    console.log('');
    console.log(colors.green + 'üëã Goodbye!' + colors.reset);
    process.exit(0);
});

// Initialize global menus and start the application
initializeGlobalMenus();
console.log(colors.dim + 'Claude Launcher v2.0.0 - Modular Edition' + colors.reset);
showMenu();
