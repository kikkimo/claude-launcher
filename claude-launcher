#!/usr/bin/env node

/**
 * Claude Launcher - Refactored modular version
 * A launcher for Claude Code with third-party API support
 */

const ApiManager = require('./lib/api-manager');
const Menu = require('./lib/ui/menu');
const colors = require('./lib/ui/colors');
const {
    waitForKey,
    promptForThirdPartyApi,
    confirmAction,
    showSuccess,
    showError,
    showInfo
} = require('./lib/ui/prompts');
const {
    launchClaudeDefault,
    launchClaudeSkipPermissions,
    launchClaudeWithApi,
    testApiConnection
} = require('./lib/launcher');
const { maskSensitiveData } = require('./lib/validators');
const fs = require('fs');
const path = require('path');

// Initialize components
const apiManager = new ApiManager();
const menu = new Menu();

// Main menu options
const menuOptions = [
    'Launch Claude Code',
    'Launch Claude Code (Skip Permissions)',
    'Launch Claude Code with 3rd-party API',
    'Launch Claude Code with 3rd-party API (Skip Permissions)',
    'Add New 3rd-party API',
    'Remove 3rd-party API',
    'Switch 3rd-party API',
    'View API Statistics',
    'Export/Import Configuration',
    'Exit'
];

/**
 * Add new third-party API
 */
async function addNewThirdPartyApi() {
    try {
        // Clean up terminal state
        if (process.stdin.isTTY) {
            process.stdin.setRawMode(false);
            process.stdin.removeAllListeners('data');
            process.stdin.pause();
        }

        const apiData = await promptForThirdPartyApi();

        // Test connection before saving
        console.log('');
        const testResult = await testApiConnection({
            baseUrl: apiData.baseUrl,
            authToken: apiData.authToken
        });

        if (!testResult.success) {
            const proceed = await confirmAction('âš ï¸  Connection test failed. Add anyway?');
            if (!proceed) {
                showInfo('API configuration cancelled');
                await waitForKey('Press any key to return to main menu...');
                return showMenu();
            }
        }

        const newApi = apiManager.addApi(
            apiData.baseUrl,
            apiData.authToken,
            apiData.model,
            apiData.name,
            apiData.provider
        );

        showSuccess('Third-party API added successfully!', [
            `Name: ${newApi.name}`,
            `Provider: ${newApi.provider}`,
            `Base URL: ${newApi.baseUrl}`,
            `Model: ${newApi.model}`
        ]);

        if (apiManager.getApis().length === 1) {
            showInfo('This is your first API - it has been set as active');
        }

    } catch (error) {
        showError('Failed to add API', [error.message]);
    }

    await waitForKey('Press any key to return to main menu...');
    showMenu();
}

/**
 * Remove third-party API
 */
async function removeThirdPartyApi() {
    try {
        const apis = apiManager.getApis();

        if (apis.length === 0) {
            showInfo('No third-party APIs configured', [
                'Please add an API first using "Add New 3rd-party API"'
            ]);
            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        const activeApi = apiManager.getActiveApi();
        const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

        const listItems = apis.map(api => ({
            name: api.name,
            details: [
                `Provider: ${api.provider}`,
                `Base URL: ${api.baseUrl}`,
                `Model: ${api.model}`
            ]
        }));

        const selectedIndex = await menu.selectFromList('Remove 3rd-party API', listItems, activeIndex);

        if (selectedIndex === null) {
            return showMenu();
        }

        const apiToRemove = apis[selectedIndex];

        console.clear();
        console.log('');
        console.log(colors.bright + colors.orange + 'âš ï¸  Confirm Removal' + colors.reset);
        console.log('');
        showInfo(`API to remove: ${apiToRemove.name}`, [
            `Base URL: ${apiToRemove.baseUrl}`,
            `Model: ${apiToRemove.model}`
        ]);

        console.log(colors.red + 'âš ï¸  This action cannot be undone!' + colors.reset);
        console.log('');

        const confirmed = await confirmAction('Are you sure you want to remove this API?');

        if (confirmed) {
            apiManager.removeApi(selectedIndex);
            showSuccess('API removed successfully!');
        } else {
            showInfo('Removal cancelled');
        }

    } catch (error) {
        showError('Failed to remove API', [error.message]);
    }

    await waitForKey('Press any key to return to main menu...');
    showMenu();
}

/**
 * Switch active third-party API
 */
async function switchThirdPartyApi() {
    try {
        const apis = apiManager.getApis();

        if (apis.length === 0) {
            showInfo('No third-party APIs configured', [
                'Please add an API first using "Add New 3rd-party API"'
            ]);
            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        const activeApi = apiManager.getActiveApi();
        const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

        const listItems = apis.map(api => ({
            name: api.name,
            details: [
                `Provider: ${api.provider}`,
                `Base URL: ${api.baseUrl}`,
                `Model: ${api.model}`,
                `Last Used: ${api.lastUsed || 'Never'}`,
                `Usage Count: ${api.usageCount || 0}`
            ]
        }));

        const selectedIndex = await menu.selectFromList('Switch 3rd-party API', listItems, activeIndex);

        if (selectedIndex === null) {
            return showMenu();
        }

        const selectedApi = apiManager.setActiveApi(selectedIndex);

        console.clear();
        showSuccess('API switched successfully!', [
            `Active API: ${selectedApi.name}`,
            `Provider: ${selectedApi.provider}`,
            `Base URL: ${selectedApi.baseUrl}`,
            `Model: ${selectedApi.model}`
        ]);

    } catch (error) {
        showError('Failed to switch API', [error.message]);
    }

    await waitForKey('Press any key to return to main menu...');
    showMenu();
}

/**
 * View API statistics
 */
async function viewStatistics() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ“Š API Statistics' + colors.reset);
    console.log('');

    const stats = apiManager.getStatistics();
    const apis = apiManager.getApis();

    console.log(colors.cyan + '  Summary:' + colors.reset);
    console.log(colors.gray + `    Total APIs: ${stats.totalApis}` + colors.reset);
    console.log(colors.gray + `    Active API: ${stats.activeApiName}` + colors.reset);
    console.log(colors.gray + `    Most Used: ${stats.mostUsedApi}` + colors.reset);
    console.log(colors.gray + `    Total Usage: ${stats.totalUsage}` + colors.reset);
    console.log('');

    if (apis.length > 0) {
        console.log(colors.cyan + '  Configured APIs:' + colors.reset);
        apis.forEach((api, index) => {
            const isActive = apiManager.getActiveApi()?.id === api.id;
            console.log(colors.gray + `    ${index + 1}. ${api.name}${isActive ? ' (ACTIVE)' : ''}` + colors.reset);
            console.log(colors.dim + `       Provider: ${api.provider}` + colors.reset);
            console.log(colors.dim + `       Usage: ${api.usageCount || 0} times` + colors.reset);
            console.log(colors.dim + `       Created: ${api.createdAt}` + colors.reset);
        });
    }

    console.log('');
    await waitForKey('Press any key to return to main menu...');
    showMenu();
}

/**
 * Export/Import configuration
 */
async function manageConfiguration() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ’¾ Configuration Management' + colors.reset);
    console.log('');

    const exportImportMenu = new Menu();
    exportImportMenu.setOptions([
        'Export Configuration (Backup)',
        'Import Configuration (Restore)',
        'Back to Main Menu'
    ]);

    const choice = await exportImportMenu.navigate();

    switch (choice) {
        case 0: // Export
            try {
                const exportData = apiManager.exportConfig();
                const filename = `claude-launcher-backup-${Date.now()}.json`;
                const filepath = path.join(process.cwd(), filename);

                fs.writeFileSync(filepath, exportData);
                showSuccess('Configuration exported successfully!', [
                    `File: ${filepath}`,
                    'Note: Auth tokens are masked for security'
                ]);
            } catch (error) {
                showError('Export failed', [error.message]);
            }
            await waitForKey('Press any key to continue...');
            break;

        case 1: // Import
            try {
                console.log(colors.yellow + 'Place the backup file in current directory' + colors.reset);
                const files = fs.readdirSync(process.cwd())
                    .filter(f => f.startsWith('claude-launcher-backup-') && f.endsWith('.json'));

                if (files.length === 0) {
                    showError('No backup files found in current directory');
                } else {
                    console.log(colors.cyan + 'Found backup files:' + colors.reset);
                    files.forEach((f, i) => {
                        console.log(colors.gray + `  ${i + 1}. ${f}` + colors.reset);
                    });
                    // Import logic would go here
                    showInfo('Import feature coming soon');
                }
            } catch (error) {
                showError('Import failed', [error.message]);
            }
            await waitForKey('Press any key to continue...');
            break;

        case 2: // Back
        default:
            break;
    }

    showMenu();
}

/**
 * Handle third-party API launch
 */
async function handleThirdPartyApiLaunch(skipPermissions = false) {
    try {
        const activeApi = apiManager.getActiveApi();

        if (!activeApi) {
            console.clear();
            showInfo('No Active Third-party API', [
                'No third-party API is currently active.',
                'Please add and configure an API first, or switch to an existing one.'
            ]);

            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        launchClaudeWithApi(activeApi, skipPermissions);

    } catch (error) {
        showError('Failed to launch with third-party API', [error.message]);

        setTimeout(() => {
            showMenu();
        }, 2000);
    }
}

/**
 * Execute selected menu item
 */
async function executeSelection(selectedIndex) {
    switch (selectedIndex) {
        case 0: // Launch Claude Code
            launchClaudeDefault();
            break;

        case 1: // Launch Claude Code (Skip Permissions)
            launchClaudeSkipPermissions();
            break;

        case 2: // Launch Claude Code with 3rd-party API
            await handleThirdPartyApiLaunch(false);
            break;

        case 3: // Launch Claude Code with 3rd-party API (Skip Permissions)
            await handleThirdPartyApiLaunch(true);
            break;

        case 4: // Add New 3rd-party API
            await addNewThirdPartyApi();
            break;

        case 5: // Remove 3rd-party API
            await removeThirdPartyApi();
            break;

        case 6: // Switch 3rd-party API
            await switchThirdPartyApi();
            break;

        case 7: // View Statistics
            await viewStatistics();
            break;

        case 8: // Export/Import Configuration
            await manageConfiguration();
            break;

        case 9: // Exit
            console.log('');
            console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
            process.exit(0);
            break;

        default:
            showMenu();
            break;
    }
}

/**
 * Show main menu
 */
async function showMenu() {
    menu.setOptions(menuOptions);
    const selection = await menu.navigate();

    if (selection === -1) {
        console.log('');
        console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
        process.exit(0);
    } else {
        await executeSelection(selection);
    }
}

/**
 * Handle process termination
 */
process.on('SIGINT', () => {
    console.log('');
    console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
    process.exit(0);
});

process.on('SIGTERM', () => {
    console.log('');
    console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
    process.exit(0);
});

// Start the application
console.log(colors.dim + 'Claude Launcher v2.0.0 - Modular Edition' + colors.reset);
showMenu();