#!/usr/bin/env node

/**
 * Claude Launcher - Refactored modular version
 * A launcher for Claude Code with third-party API support
 */

const ApiManager = require('./lib/api-manager');
const Menu = require('./lib/ui/menu');
const colors = require('./lib/ui/colors');
const {
    waitForKey,
    promptForThirdPartyApi,
    confirmAction,
    showSuccess,
    showError,
    showInfo
} = require('./lib/ui/prompts');
const {
    launchClaudeDefault,
    launchClaudeSkipPermissions,
    launchClaudeWithApi
} = require('./lib/launcher');
const { getPasswordInput } = require('./lib/auth/password-input');
const { verifyExportPassword, setupNewPassword, changePassword: changePasswordModule } = require('./lib/auth/password-validator');

// Initialize components
const apiManager = new ApiManager();
const menu = new Menu();

// Main menu options - simplified to 6 items
const menuOptions = [
    'Launch Claude Code',
    'Launch Claude Code (Skip Permissions)',
    'Launch Claude Code with 3rd-party API',
    'Launch Claude Code with 3rd-party API (Skip Permissions)',
    '3rd-party API Management',
    'Exit'
];

/**
 * Add new third-party API
 */
async function addNewThirdPartyApi() {
    try {
        const apiData = await promptForThirdPartyApi();

        // Check if this is the first API
        const isFirstApi = apiManager.getApis().length === 0;
        const hasExportPassword = apiManager.hasExportPassword();

        const newApi = apiManager.addApi(
            apiData.baseUrl,
            apiData.authToken,
            apiData.model,
            apiData.name,
            apiData.provider
        );

        showSuccess('Third-party API added successfully!', [
            `Name: ${newApi.name}`,
            `Provider: ${newApi.provider}`,
            `Base URL: ${newApi.baseUrl}`,
            `Model: ${newApi.model}`
        ]);

        if (isFirstApi) {
            showInfo('This is your first API - it has been set as active');
        }

    } catch (error) {
        showError('Failed to add API', [error.message]);
    }

    await waitForKey('Press any key to continue...');
}

/**
 * Remove third-party API
 */
async function removeThirdPartyApi() {
    try {
        const apis = apiManager.getApis();

        if (apis.length === 0) {
            showInfo('No third-party APIs configured', [
                'Please add an API first using "Add New 3rd-party API"'
            ]);
            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        const activeApi = apiManager.getActiveApi();
        const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

        const listItems = apis.map(api => {
            // Decrypt and mask the API token for display
            const { decrypt } = require('./lib/crypto');
            let maskedToken;

            try {
                // All stored tokens are encrypted, decrypt for display
                const decrypted = decrypt(api.authToken);
                if (decrypted.success) {
                    maskedToken = maskApiToken(decrypted.value);
                } else {
                    maskedToken = '***DECRYPT_ERROR***';
                }
            } catch (error) {
                console.error('Error decrypting token:', error);
                maskedToken = '***ERROR***';
            }

            return {
                name: api.name,
                details: [
                    `Provider: ${api.provider}`,
                    `Base URL: ${api.baseUrl}`,
                    `Model: ${api.model}`,
                    `API Token: ${maskedToken}`
                ]
            };
        });

        const selectedIndex = await menu.selectFromList('Remove 3rd-party API', listItems, activeIndex);

        if (selectedIndex === null) {
            return showMenu();
        }

        const apiToRemove = apis[selectedIndex];

        console.clear();
        console.log('');
        console.log(colors.bright + colors.orange + 'âš ï¸  Confirm Removal' + colors.reset);
        console.log('');
        showInfo(`API to remove: ${apiToRemove.name}`, [
            `Base URL: ${apiToRemove.baseUrl}`,
            `Model: ${apiToRemove.model}`
        ]);

        console.log(colors.red + 'âš ï¸  This action cannot be undone!' + colors.reset);
        console.log('');

        const confirmed = await confirmAction('Are you sure you want to remove this API?');

        if (confirmed) {
            try {
                apiManager.removeApi(selectedIndex);
                showSuccess('API removed successfully!');
                await waitForKey('Press any key to continue...');
                return;
            } catch (removeError) {
                showError('Failed to remove API', [removeError.message]);
                await waitForKey('Press any key to continue...');
                return;
            }
        } else {
            showInfo('Removal cancelled');
            await waitForKey('Press any key to continue...');
            return;
        }

    } catch (error) {
        showError('Failed to remove API', [error.message]);
        await waitForKey('Press any key to continue...');
    }
}

/**
 * Switch active third-party API
 */
async function switchThirdPartyApi() {
    try {
        const apis = apiManager.getApis();

        if (apis.length === 0) {
            showInfo('No third-party APIs configured', [
                'Please add an API first using "Add New 3rd-party API"'
            ]);
            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        const activeApi = apiManager.getActiveApi();
        const activeIndex = activeApi ? apis.findIndex(api => api.id === activeApi.id) : -1;

        const listItems = apis.map(api => {
            // Decrypt and mask the API token for display
            const { decrypt } = require('./lib/crypto');
            let maskedToken;

            try {
                // All stored tokens are encrypted, decrypt for display
                const decrypted = decrypt(api.authToken);
                if (decrypted.success) {
                    maskedToken = maskApiToken(decrypted.value);
                } else {
                    maskedToken = '***DECRYPT_ERROR***';
                }
            } catch (error) {
                console.error('Error decrypting token:', error);
                maskedToken = '***ERROR***';
            }

            return {
                name: api.name,
                details: [
                    `Provider: ${api.provider}`,
                    `Base URL: ${api.baseUrl}`,
                    `Model: ${api.model}`,
                    `API Token: ${maskedToken}`,
                    `Last Used: ${api.lastUsed || 'Never'}`,
                    `Usage Count: ${api.usageCount || 0}`
                ]
            };
        });

        const selectedIndex = await menu.selectFromList('Switch 3rd-party API', listItems, activeIndex);

        if (selectedIndex === null) {
            return showMenu();
        }

        const selectedApi = apiManager.setActiveApi(selectedIndex);

        console.clear();
        showSuccess('API switched successfully!', [
            `Active API: ${selectedApi.name}`,
            `Provider: ${selectedApi.provider}`,
            `Base URL: ${selectedApi.baseUrl}`,
            `Model: ${selectedApi.model}`
        ]);

    } catch (error) {
        showError('Failed to switch API', [error.message]);
    }

    await waitForKey('Press any key to continue...');
}

/**
 * View API statistics
 */
async function viewStatistics() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ“Š API Statistics' + colors.reset);
    console.log('');

    const stats = apiManager.getStatistics();
    const apis = apiManager.getApis();

    console.log(colors.cyan + '  Summary:' + colors.reset);
    console.log(colors.gray + `    Total APIs: ${stats.totalApis}` + colors.reset);
    console.log(colors.gray + `    Active API: ${stats.activeApiName}` + colors.reset);
    console.log(colors.gray + `    Most Used: ${stats.mostUsedApi}` + colors.reset);
    console.log(colors.gray + `    Total Usage: ${stats.totalUsage}` + colors.reset);
    console.log('');

    if (apis.length > 0) {
        console.log(colors.cyan + '  Configured APIs:' + colors.reset);
        apis.forEach((api, index) => {
            const isActive = apiManager.getActiveApi()?.id === api.id;
            console.log(colors.gray + `    ${index + 1}. ${api.name}${isActive ? ' (ACTIVE)' : ''}` + colors.reset);
            console.log(colors.dim + `       Provider: ${api.provider}` + colors.reset);
            console.log(colors.dim + `       Usage: ${api.usageCount || 0} times` + colors.reset);
            console.log(colors.dim + `       Created: ${api.createdAt}` + colors.reset);
        });
    }

    console.log('');
    await waitForKey('Press any key to continue...');
}


/**
 * Handle first time password setup
 */
async function handleFirstTimePasswordSetup() {
    while (true) {
        // Clear screen and show header
        console.clear();
        console.log('');
        console.log(colors.bright + colors.yellow + 'ðŸ” First Time Import/Export Setup' + colors.reset);
        console.log('');

        // Show information
        console.log(colors.cyan + 'Why password is needed:' + colors.reset);
        console.log(colors.gray + 'â€¢ Import/export features require password verification for user identity' + colors.reset);
        console.log(colors.gray + 'â€¢ Exported configurations are in plaintext format for cross-machine compatibility' + colors.reset);
        console.log(colors.gray + 'â€¢ Local configurations remain encrypted, password ensures only you can access them' + colors.reset);
        console.log('');
        console.log(colors.yellow + 'Options:' + colors.reset);
        console.log(colors.gray + 'â€¢ Set Password: Enable import/export functionality with identity verification' + colors.reset);
        console.log(colors.gray + 'â€¢ Skip Setup: Permanently disable import/export features (cannot be undone)' + colors.reset);
        console.log('');
        console.log(colors.red + 'WARNING: Skipping setup will permanently disable import/export functionality!' + colors.reset);
        console.log('');

        // Show menu options statically
        console.log(colors.orange + '  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”' + colors.reset);
        console.log(colors.orange + '  â”‚' + colors.white + colors.bright + '           Claude Code Launcher         ' + colors.orange + 'â”‚' + colors.reset);
        console.log(colors.orange + '  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜' + colors.reset);
        console.log('');
        console.log(colors.gray + '  Use number keys to select:' + colors.reset);
        console.log('');
        console.log(colors.yellow + '  1. ' + colors.reset + 'Set Password (Recommended)');
        console.log(colors.yellow + '  2. ' + colors.reset + 'Skip Setup (Permanently Disable Import/Export)');
        console.log(colors.gray + '  Any other key: ' + colors.reset + 'Back to Main Menu');
        console.log('');

        // Use simple input instead of Menu class to avoid refresh issues
        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const choice = await new Promise((resolve) => {
            rl.question(colors.green + '[>] Enter your choice (1-2, or any other key to return to main menu): ' + colors.reset, (answer) => {
                rl.close();
                resolve(parseInt(answer) - 1);
            });
        });

        switch (choice) {
            case 0: // Set password
                const passwordResult = await promptForPasswordSetup();
                if (passwordResult) {
                    return true; // Password set successfully
                }
                // If password setup failed, continue loop to show menu again
                break;

            case 1: // Skip setup
                const skipResult = await confirmSkipPassword();
                if (skipResult === true) {
                    return true; // Skip confirmed
                } else if (skipResult === 'reconsider') {
                    continue; // Return to main setup menu
                }
                // If skip was canceled, continue loop
                break;

            case 2: // Back to main menu
            default:
                return false; // Exit setup
        }
    }
}

/**
 * Prompt user to set password
 */
async function promptForPasswordSetup() {
    const result = await setupNewPassword(apiManager, true);
    if (result) {
        await waitForKey('Press any key to continue...');
    }
    return result;
}

/**
 * Confirm skip password setup
 */
async function confirmSkipPassword() {
    console.log('');
    console.log(colors.bright + colors.red + 'âš ï¸  Confirm Skip Password Setup' + colors.reset);
    console.log('');
    console.log(colors.gray + 'After skipping password setup:' + colors.reset);
    console.log(colors.gray + 'â€¢ Import/export functionality will be permanently disabled' + colors.reset);
    console.log(colors.gray + 'â€¢ Cannot backup or migrate API configurations' + colors.reset);
    console.log(colors.gray + 'â€¢ This decision cannot be undone' + colors.reset);
    console.log('');

    const confirmMenu = new Menu();
    confirmMenu.setOptions([
        'I confirm to skip',
        'Reconsider, return to password setup'
    ]);

    const choice = await confirmMenu.navigate();

    if (choice === 0) {
        try {
            apiManager.skipPasswordSetup();
            console.log(colors.yellow + 'Password setup skipped, import/export functionality permanently disabled' + colors.reset);
            await waitForKey('Press any key to continue...');
            return true;
        } catch (error) {
            console.log(colors.red + `Operation failed: ${error.message}` + colors.reset);
            await waitForKey('Press any key to continue...');
            return false;
        }
    }

    return 'reconsider'; // Return to password setup main menu
}

/**
 * Show API Management Menu
 */
async function showApiManagementMenu() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ“‹ 3rd-party API Management' + colors.reset);
    console.log('');

    // Check if this is first time usage and prompt for password setup
    if (apiManager.isFirstTimeUsage()) {
        const passwordChoice = await handleFirstTimePasswordSetup();
        if (!passwordChoice) {
            // User chose to skip or canceled, return to main menu
            return showMenu();
        }
    }

    // Build menu options based on password setup status
    const menuOptions = [
        'Add New API',
        'Remove API',
        'Switch Active API',
        'View API Statistics'
    ];

    // Add import/export options only if password is set
    if (apiManager.canUseImportExport()) {
        menuOptions.push('Export Configuration');
        menuOptions.push('Import Configuration');
        menuOptions.push('Change Password');
    }

    menuOptions.push('Back to Main Menu');

    const apiManagementMenu = new Menu();
    apiManagementMenu.setOptions(menuOptions);

    const choice = await apiManagementMenu.navigate();

    // Handle menu choices based on current menu options
    if (choice === 0) { // Add New API
        await addNewThirdPartyApi();
    } else if (choice === 1) { // Remove API
        await removeThirdPartyApi();
    } else if (choice === 2) { // Switch Active API
        await switchThirdPartyApi();
    } else if (choice === 3) { // View API Statistics
        await viewStatistics();
    } else if (apiManager.canUseImportExport()) {
        // If import/export is available, handle those options
        if (choice === 4) { // Export Configuration
            await exportConfiguration();
        } else if (choice === 5) { // Import Configuration
            await importConfiguration();
        } else if (choice === 6) { // Change Password
            await changePassword();
        } else if (choice === 7) { // Back to Main Menu
            return showMenu();
        }
    } else {
        // If import/export is not available, only Back to Main Menu
        if (choice === 4) { // Back to Main Menu
            return showMenu();
        }
    }

    // Return to API management menu after completing action
    showApiManagementMenu();
}

/**
 * Handle third-party API launch
 */
async function handleThirdPartyApiLaunch(skipPermissions = false) {
    try {
        const activeApi = apiManager.getActiveApi();

        if (!activeApi) {
            console.clear();
            showInfo('No Active Third-party API', [
                'No third-party API is currently active.',
                'Please add and configure an API first, or switch to an existing one.'
            ]);

            await waitForKey('Press any key to return to main menu...');
            return showMenu();
        }

        launchClaudeWithApi(activeApi, skipPermissions);

    } catch (error) {
        showError('Failed to launch with third-party API', [error.message]);

        setTimeout(() => {
            showMenu();
        }, 2000);
    }
}

/**
 * Execute selected menu item
 */
async function executeSelection(selectedIndex) {
    switch (selectedIndex) {
        case 0: // Launch Claude Code
            launchClaudeDefault();
            break;

        case 1: // Launch Claude Code (Skip Permissions)
            launchClaudeSkipPermissions();
            break;

        case 2: // Launch Claude Code with 3rd-party API
            await handleThirdPartyApiLaunch(false);
            break;

        case 3: // Launch Claude Code with 3rd-party API (Skip Permissions)
            await handleThirdPartyApiLaunch(true);
            break;

        case 4: // 3rd-party API Management
            await showApiManagementMenu();
            break;

        case 5: // Exit
            console.log('');
            console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
            process.exit(0);
            break;

        default:
            showMenu();
            break;
    }
}

/**
 * Show main menu
 */
async function showMenu() {
    menu.setOptions(menuOptions);
    const selection = await menu.navigate();

    if (selection === -1) {
        console.log('');
        console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
        process.exit(0);
    } else {
        await executeSelection(selection);
    }
}





/**
 * Export configuration with password encryption
 */
async function exportConfiguration() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ’¾ Export Configuration' + colors.reset);
    console.log('');

    // Add export function description
    console.log(colors.cyan + 'ðŸ“„ Export Function Description:' + colors.reset);
    console.log(colors.gray + '  â€¢ Password verification required to confirm your identity' + colors.reset);
    console.log(colors.gray + '  â€¢ Exported data is in plaintext JSON format for easy migration' + colors.reset);
    console.log(colors.gray + '  â€¢ Export includes all API configurations (keys are encrypted in storage)' + colors.reset);
    console.log('');

    // Verify password before export
    const verified = await verifyExportPassword(apiManager, 'export');
    if (!verified) {
        console.log('');
        await waitForKey('Press any key to return...');
        return;
    }

    try {
        // Export plaintext configuration data directly, no additional password needed
        const exportData = apiManager.exportConfigAuthenticated();

        console.log(colors.green + 'âœ“ Configuration exported successfully' + colors.reset);
        console.log('');
        console.log(colors.yellow + 'ðŸ“‹ Exported Configuration Data (Plaintext JSON):' + colors.reset);
        console.log(colors.gray + 'â”'.repeat(50) + colors.reset);
        console.log(exportData);
        console.log(colors.gray + 'â”'.repeat(50) + colors.reset);
        console.log('');
        console.log(colors.cyan + 'Please copy the above content and save to a file' + colors.reset);
        console.log(colors.gray + 'Recommended to save as .json file format for easy import and migration' + colors.reset);

    } catch (error) {
        console.log(colors.red + `âŒ Export failed: ${error.message}` + colors.reset);
    }

    console.log('');
    await waitForKey('Press any key to return...');
}

/**
 * Import configuration from plaintext JSON
 */
async function importConfiguration() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ“¥ Import Configuration' + colors.reset);
    console.log('');

    // Add import function description
    console.log(colors.cyan + 'ðŸ“„ Import Function Description:' + colors.reset);
    console.log(colors.gray + '  â€¢ Password verification required to confirm your identity' + colors.reset);
    console.log(colors.gray + '  â€¢ Import data should be in plaintext JSON format' + colors.reset);
    console.log(colors.gray + '  â€¢ Import data will be merged with current configuration (no overwrite)' + colors.reset);
    console.log(colors.gray + '  â€¢ Duplicate API configurations will be automatically skipped' + colors.reset);
    console.log('');

    // Verify password identity
    const passwordVerified = await verifyExportPassword(apiManager, 'import');
    if (!passwordVerified) {
        await waitForKey('Press any key to return...');
        return;
    }

    console.log('');
    console.log(colors.cyan + 'Please paste configuration data (plaintext JSON format):' + colors.reset);
    console.log(colors.gray + '(Press Enter when finished pasting)' + colors.reset);

    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    let configData = '';
    rl.on('line', (line) => {
        configData += line + '\n';
    });

    await new Promise((resolve) => {
        rl.question('', () => {
            rl.close();
            resolve();
        });
    });

    try {
        // Import plaintext configuration data directly, no password decryption needed
        const result = apiManager.importConfigAuthenticated(configData.trim());

        console.log(colors.green + 'âœ“ Configuration imported successfully' + colors.reset);
        console.log('');
        console.log(colors.cyan + `Import Statistics:` + colors.reset);
        console.log(colors.gray + `â€¢ Successfully imported: ${result.imported} API configurations` + colors.reset);
        console.log(colors.gray + `â€¢ Skipped duplicates: ${result.skipped} API configurations` + colors.reset);
        console.log(colors.gray + `â€¢ Configuration merged with existing data` + colors.reset);

    } catch (error) {
        console.log(colors.red + `âŒ Import failed: ${error.message}` + colors.reset);
    }

    console.log('');
    await waitForKey('Press any key to return...');
}

/**
 * Change password
 */
async function changePassword() {
    console.clear();
    console.log('');
    console.log(colors.bright + colors.orange + 'ðŸ”‘ Change Password' + colors.reset);
    console.log('');

    // Use unified password change module
    const success = await changePasswordModule(apiManager);

    if (success) {
        console.log('');
    }

    await waitForKey('Press any key to return...');
}

// End of API Management functions

/**
 * Graceful shutdown handlers
 */
process.on('SIGINT', () => {
    console.log('');
    console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
    process.exit(0);
});

process.on('SIGTERM', () => {
    console.log('');
    console.log(colors.green + 'ðŸ‘‹ Goodbye!' + colors.reset);
    process.exit(0);
});

// Start the application
console.log(colors.dim + 'Claude Launcher v2.0.0 - Modular Edition' + colors.reset);
showMenu();
